<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT記憶プロンプト作成ツール</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #dropZone {
      border: 2px dashed #888;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      color: #666;
    }
    #fileList {
      margin-top: 10px;
      list-style: none;
      padding-left: 0;
    }
    #fileList li {
      margin-bottom: 6px;
    }
    .remove-btn {
      margin-left: 10px;
      background: #e33;
      color: white;
      border: none;
      padding: 3px 7px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 4px;
    }
    #preview {
      white-space: pre-wrap;
      background: #f0f0f0;
      padding: 15px;
      border: 1px solid #ccc;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    #description {
      margin-top: 40px;
      padding: 20px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      line-height: 1.6;
    }
  </style>
</head>
<body>

<h2>ChatGPT記憶プロンプト作成ツール</h2>

<div id="dropZone">ここにファイルをドラッグ＆ドロップしてください（複数可）</div>

<ul id="fileList"></ul>

<button onclick="generatePrompt()">ChatGPT 記憶のプロンプトを作成する</button>

<h3>📄 コピーされるプロンプトのプレビュー</h3>
<pre id="preview">(まだ生成されていません)</pre>

<div id="description">
  <h3>使い方</h3>
  <ol>
    <li>上の枠にテキストファイル（.txt, .json, .md など）をドラッグ＆ドロップしてください。</li>
    <li>ドロップされたファイルは一覧に追加されます（何度でも追加可能）。</li>
    <li>「ChatGPT 記憶のプロンプトを作成する」ボタンを押すと、以下の形式でクリップボードにコピーされます。</li>
  </ol>
  <pre>
下記の内容を最新の内容として記憶して下さい。

[example.txt]
（ファイル内容）

[example2.json]
（ファイル内容）
  </pre>
  <p><strong>※ファイルを1つも追加していない状態では、コピーは行われず、警告が表示されます。</strong></p>
  <p><strong>※同じファイル名のファイルは2回目以降無視されます。</strong></p>
  <p><strong>※バイナリファイルや文字化けのあるファイルは自動で除外されます。</strong></p>
  <p><strong>※mp3, png, pdfなどの非テキスト系ファイルは拡張子で除外されます。</strong></p>
</div>

<script>
  const fileContents = [];
  const dropZone = document.getElementById('dropZone');
  const fileList = document.getElementById('fileList');
  const preview = document.getElementById('preview');

  const deniedExtensions = ['mp3', 'mp4', 'wav', 'ogg', 'jpg', 'jpeg', 'png', 'gif', 'pdf', 'zip', 'rar', '7z', 'exe', 'dll', 'bin', 'mov', 'avi'];

  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.style.borderColor = '#00f';
  });

  dropZone.addEventListener('dragleave', e => {
    dropZone.style.borderColor = '#888';
  });

  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.style.borderColor = '#888';
    const files = e.dataTransfer.files;

    [...files].forEach(file => {
      const ext = file.name.split('.').pop().toLowerCase();
      if (deniedExtensions.includes(ext)) {
        alert(`${file.name} は非対応のファイル形式（.${ext}）のため読み込まれませんでした。`);
        return;
      }

      if (fileContents.some(f => f.name === file.name)) {
        return; // 重複スキップ
      }

      const reader = new FileReader();
      reader.onload = () => {
        const content = reader.result;
        const garbledCount = (content.match(/\uFFFD/g) || []).length;
        if (garbledCount > 5) {
          alert(`${file.name} は文字化けのため読み込まれませんでした。`);
          return;
        }

        fileContents.push({ name: file.name, content });
        const li = document.createElement('li');
        li.textContent = file.name;

        const removeBtn = document.createElement('button');
        removeBtn.textContent = '－';
        removeBtn.className = 'remove-btn';
        removeBtn.onclick = () => {
          const index = fileContents.findIndex(f => f.name === file.name);
          if (index !== -1) {
            fileContents.splice(index, 1);
            fileList.removeChild(li);
            updatePreview();
          }
        };

        li.appendChild(removeBtn);
        fileList.appendChild(li);
      };
      reader.readAsText(file, 'utf-8');
    });
  });

  function generatePrompt() {
    if (fileContents.length === 0) {
      alert("ファイルをドラッグ＆ドロップして下さい。");
      return;
    }

    const prompt = buildPrompt();
    preview.textContent = prompt;

    navigator.clipboard.writeText(prompt).then(() => {
      alert("プロンプトをクリップボードにコピーしました！");
    }).catch(err => {
      alert("コピーに失敗しました: " + err);
    });
  }

  function buildPrompt() {
    let prompt = "下記の内容を最新の内容として記憶して下さい。\n\n";
    fileContents.forEach(file => {
      prompt += `[${file.name}]\n${file.content}\n\n`;
    });
    return prompt;
  }

  function updatePreview() {
    if (fileContents.length === 0) {
      preview.textContent = '(まだ生成されていません)';
    } else {
      preview.textContent = buildPrompt();
    }
  }
</script>

</body>
</html>
